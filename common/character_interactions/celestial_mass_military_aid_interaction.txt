celestial_mass_military_aid_interaction = {
	icon = icon_soldier_survivor
	interface_priority = 71
	category = interaction_category_vassal
	common_interaction = no
	auto_accept = yes

	desc = celestial_mass_military_aid_interaction_desc

	popup_on_receive = yes
	pause_on_receive = yes

	pre_answer_yes_key = ACCEPT
	pre_answer_no_key = DECLINE

	is_shown = {
		scope:actor = {
			OR = {
				# If you are the minister of war
				has_title = title:e_minister_of_war
				# Or if you are an independent admin ruler with military governors
				AND = {
					top_liege = this
					government_allows = administrative
					government_allows = merit
				}
			}
		}
		scope:recipient = {
			top_liege = scope:actor.top_liege
			OR = {
				is_landed = yes
				has_title = title:e_minister_grand_marshal
			}
		}
	}

	is_valid_showing_failures_only = {
		custom_tooltip = {
			text = celestial_request_military_aid_no_military_governors_desc
			scope:recipient.top_liege = {
				any_vassal_or_below = {
					OR = {
						vassal_contract_has_flag = celestial_military_appointment
						vassal_contract_has_flag = meritocratic_military_appointment
					}
				}
			}
		}

		custom_tooltip = {
			text = celestial_request_military_aid_no_available_military_governors_desc
			scope:recipient.top_liege = {
				any_vassal_or_below = {
					tgp_celestial_military_governor_can_join_war_trigger = {
						TARGET_GOVERNOR = scope:recipient
						MINISTER_OF_WAR = scope:actor
					}
				}
			}
		}

		scope:recipient = {
			is_at_war = yes # Has to be at war
			is_at_war_with_liege = no # But not with liege
			NOT = { is_at_war_with = scope:actor }
			# Has to be a war leader
			trigger_if = {
				limit = { is_at_war = yes }
				custom_description = {
					text = target_is_not_war_leader
					object = scope:recipient
					any_character_war = {
						scope:recipient = { is_leader_in_war = prev }
					}
				}
			}
		}
	}

	can_send = {
	}

	on_send = {
	}
	
	is_highlighted = {
		scope:recipient = {
			is_at_war = yes
		}
	}

	cost = {
		influence = {
			value = {
				add = medium_influence_value
				multiply = mass_military_aid_governor_count
				desc = BASE
			}
			if = {
				limit = {
					scope:actor = { has_title = title:e_minister_of_war }
				}
				multiply = {
					value = 0.25
					desc = "[minister_of_war|E]"
				}
			}
		}
	}

	on_accept = {

		# Save the war leader (same semantic role as vanilla recipient)
		scope:recipient = {
			save_scope_as = governor_at_war
		}

		# Loop all eligible military governors
		scope:actor.top_liege = {
			every_vassal_or_below = {
				limit = {
					tgp_celestial_military_governor_can_join_war_trigger = {
						TARGET_GOVERNOR = scope:governor_at_war
						MINISTER_OF_WAR = scope:actor
					}
				}

				# Match vanilla naming
				save_scope_as = governor_joining

				# Vanilla copy
				scope:governor_at_war = {
					# Have secondary_recipient join recipient's wars
					every_character_war = {
						limit = {
							scope:governor_at_war = { is_leader_in_war = prev }
							is_attacker = scope:governor_at_war
						}
						add_attacker = scope:governor_joining
					}
					every_character_war = {
						limit = {
							scope:governor_at_war = { is_leader_in_war = prev }
							is_defender = scope:governor_at_war
						}
						add_defender = scope:governor_joining
					}

					# If recipient is AI, add some opinion
					if = {
						limit = { is_ai = yes }
						add_opinion = {
							target = scope:actor
							modifier = grateful_opinion
							opinion = 10
						}
					}

					# Send recipient a letter event and let them know of your action
					if = {
						limit = {
							scope:actor != scope:governor_at_war
						}
						trigger_event = {
							id = tgp_interaction_event.0015
						}
					}
				}

				# Send recipient a letter event and let them know of your action
				scope:governor_joining = {
					trigger_event = {
						id = tgp_interaction_event.0016
					}
				}
			}
		}

		# Toast
		scope:actor = {
			hidden_effect = {
				send_interface_toast = {
					type = event_toast_effect_neutral
					title = celestial_send_military_aid_confirmation
					left_icon = scope:recipient

					custom_tooltip = celestial_mass_military_aid_confirmation
				}
			}
		}
	}
}